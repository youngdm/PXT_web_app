<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Validation & Export - PXT Web App</title>
    <style>
      /* Consistent styling with other templates */
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
        color: #333;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background-color: white;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
        border-radius: 8px;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #2c5530;
      }

      .header h1 {
        color: #2c5530;
        margin: 0;
        font-size: 2.2em;
      }

      .header .subtitle {
        color: #666;
        font-size: 1.1em;
        margin-top: 5px;
      }

      .validation-summary {
        background-color: #e8f4ea;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
        border-left: 4px solid #2c5530;
      }

      .validation-summary h2 {
        color: #2c5530;
        margin-top: 0;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 15px 0;
      }

      .summary-item {
        background-color: white;
        padding: 15px;
        border-radius: 4px;
        text-align: center;
        border: 1px solid #ddd;
      }

      .summary-item .number {
        font-size: 1.8em;
        font-weight: bold;
        color: #2c5530;
      }

      .summary-item.success .number {
        color: #28a745;
      }

      .summary-item.warning .number {
        color: #ffc107;
      }

      .summary-item.danger .number {
        color: #dc3545;
      }

      .summary-item .label {
        color: #666;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .progress-section {
        margin: 30px 0;
      }

      .progress-bar {
        background-color: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        height: 20px;
        margin: 10px 0;
      }

      .progress-fill {
        height: 100%;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 0.9em;
      }

      .progress-fill.excellent {
        background-color: #28a745;
      }

      .progress-fill.good {
        background-color: #ffc107;
        color: black;
      }

      .progress-fill.needs-work {
        background-color: #dc3545;
      }

      .mappings-section {
        margin: 30px 0;
      }

      .mappings-section h3 {
        color: #2c5530;
        border-bottom: 2px solid #e8f4ea;
        padding-bottom: 5px;
      }

      .mapping-table {
        width: 100%;
        border-collapse: collapse;
        margin: 15px 0;
        background-color: white;
        border: 1px solid #ddd;
      }

      .mapping-table th {
        background-color: #2c5530;
        color: white;
        padding: 12px 8px;
        text-align: left;
        font-weight: 600;
      }

      .mapping-table td {
        padding: 10px 8px;
        border-bottom: 1px solid #eee;
      }

      .mapping-table tr:nth-child(even) {
        background-color: #f8f9fa;
      }

      .tag-priority {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.8em;
        font-weight: 500;
      }

      .priority-required {
        background-color: #dc3545;
        color: white;
      }

      .priority-desirable {
        background-color: #ffc107;
        color: black;
      }

      .priority-optional {
        background-color: #6c757d;
        color: white;
      }

      .validation-details {
        margin: 30px 0;
      }

      .validation-card {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin: 15px 0;
      }

      .validation-card.success {
        background-color: #d4edda;
        border-color: #c3e6cb;
      }

      .validation-card.warning {
        background-color: #fff3cd;
        border-color: #ffeaa7;
      }

      .validation-card.danger {
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }

      .validation-card h4 {
        margin-top: 0;
        color: #2c5530;
      }

      .validation-card.success h4 {
        color: #155724;
      }

      .validation-card.warning h4 {
        color: #856404;
      }

      .validation-card.danger h4 {
        color: #721c24;
      }

      .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }

      .tag-item {
        background-color: white;
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid #ddd;
        font-family: monospace;
        font-size: 0.9em;
      }

      .actions {
        text-align: center;
        margin: 40px 0;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
      }

      .btn {
        display: inline-block;
        padding: 12px 24px;
        margin: 0 10px;
        border: none;
        border-radius: 4px;
        font-size: 1.1em;
        text-decoration: none;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .btn-primary {
        background-color: #2c5530;
        color: white;
      }

      .btn-primary:hover {
        background-color: #1a3320;
      }

      .btn-success {
        background-color: #28a745;
        color: white;
      }

      .btn-success:hover {
        background-color: #1e7e34;
      }

      .btn-secondary {
        background-color: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background-color: #545b62;
      }

      .flash-messages {
        margin: 20px 0;
      }

      .flash-message {
        padding: 12px 16px;
        border-radius: 4px;
        margin: 10px 0;
      }

      .flash-message.success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }

      .flash-message.error {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }

      .footer {
        text-align: center;
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid #eee;
        color: #666;
        font-size: 0.9em;
      }

      .note {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        padding: 15px;
        border-radius: 4px;
        margin: 20px 0;
        color: #856404;
      }

      /* Responsive design */
      @media (max-width: 768px) {
        .container {
          margin: 10px;
          padding: 15px;
        }

        .mapping-table {
          font-size: 0.9em;
        }

        .summary-grid {
          grid-template-columns: 1fr 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <h1>Validation & Export</h1>
        <div class="subtitle">
          Review your PXT tag mappings and download standardized data
        </div>
      </div>

      <!-- Flash Messages -->
      <div class="flash-messages">
        {% with messages = get_flashed_messages(with_categories=true) %} {% if
        messages %} {% for category, message in messages %}
        <div class="flash-message {{ category }}">{{ message }}</div>
        {% endfor %} {% endif %} {% endwith %}
      </div>

      <!-- Validation Summary -->
      <div class="validation-summary">
        <h2>📊 Validation Summary</h2>
        <div class="summary-grid">
          <div
            class="summary-item {% if validation.mapped_columns == validation.total_columns %}success{% elif validation.mapped_columns > validation.total_columns * 0.5 %}warning{% else %}danger{% endif %}"
          >
            <div class="number">
              {{ validation.mapped_columns }} of {{ validation.total_columns }}
            </div>
            <div class="label">Columns Tagged</div>
          </div>
          <div
            class="summary-item {% if validation.required_count > 0 %}success{% else %}warning{% endif %}"
          >
            <div class="number">{{ validation.required_count }}</div>
            <div class="label">Required Found</div>
          </div>
          <div
            class="summary-item {% if validation.desirable_count > 0 %}success{% else %}warning{% endif %}"
          >
            <div class="number">{{ validation.desirable_count }}</div>
            <div class="label">Desirable Found</div>
          </div>
          <div
            class="summary-item {% if validation.optional_count > 0 %}success{% else %}secondary{% endif %}"
          >
            <div class="number">{{ validation.optional_count }}</div>
            <div class="label">Optional Found</div>
          </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-section">
          <h4>Column Mapping Progress</h4>
          <div class="progress-bar">
            <div
              class="progress-fill {% if validation.mapping_percentage >= 80 %}excellent{% elif validation.mapping_percentage >= 50 %}good{% else %}needs-work{% endif %}"
              style="width: {{ validation.mapping_percentage }}%"
            >
              {{ validation.mapping_percentage|round|int }}%
            </div>
          </div>
          <p>
            {{ validation.mapped_columns }} of {{ validation.total_columns }}
            columns have been tagged with PXT metadata.
          </p>
        </div>
      </div>

      <!-- Validation Details -->
      <div class="validation-details">
        <h3>🔍 Validation Details</h3>

        <!-- Required Fields Found -->
        {% if validation.required_found %}
        <div class="validation-card success">
          <h4>✅ Required Fields Found ({{ validation.required_count }})</h4>
          <p>These essential PXT tags have been suggested for your dataset:</p>
          <div class="tag-list">
            {% for tag in validation.required_found %}
            <span class="tag-item">{{ tag }}</span>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Desirable Fields Found -->
        {% if validation.desirable_found %}
        <div class="validation-card success">
          <h4>✅ Desirable Fields Found ({{ validation.desirable_count }})</h4>
          <p>
            These recommended PXT tags have been suggested for your dataset:
          </p>
          <div class="tag-list">
            {% for tag in validation.desirable_found %}
            <span class="tag-item">{{ tag }}</span>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Optional Fields Found -->
        {% if validation.optional_found %}
        <div class="validation-card success">
          <h4>✅ Optional Fields Found ({{ validation.optional_count }})</h4>
          <p>These optional PXT tags have been suggested for your dataset:</p>
          <div class="tag-list">
            {% for tag in validation.optional_found %}
            <span class="tag-item">{{ tag }}</span>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Untagged Columns -->
        {% if validation.untagged_columns > 0 %}
        <div class="validation-card warning">
          <h4>📊 Untagged Columns ({{ validation.untagged_columns }})</h4>
          <p>
            These columns don't have suggested PXT tags. This may be because
            they contain measurement data or there are no appropriate PXT
            metadata tags available. You can review and manually assign tags if
            needed.
          </p>
        </div>
        {% endif %}

        <!-- Note about suggestions -->
        <div class="note">
          <strong>Note:</strong> The suggested tags are automatically generated
          and should be reviewed. You can modify any tag assignments before
          export to ensure accuracy.
        </div>

        <!-- All Mappings Table -->
        <div class="mappings-section">
          <h4>🏷️ All Column Mappings</h4>
          {% if mappings %}
          <div style="overflow-x: auto">
            <table class="mapping-table">
              <thead>
                <tr>
                  <th>CSV Column</th>
                  <th>PXT Tag</th>
                  <th>Priority</th>
                  <th>Level</th>
                </tr>
              </thead>
              <tbody>
                {% for column in data.columns %} {% set mapping_info =
                enhanced_mappings[column] %}
                <tr>
                  <td><code>{{ column }}</code></td>
                  <td>
                    {% if mapping_info.tag %}
                    <code>{{ mapping_info.tag }}</code>
                    {% else %}
                    <em style="color: #999">No tag assigned</em>
                    {% endif %}
                  </td>
                  <td>
                    {% if mapping_info.tag %}
                    <span
                      class="tag-priority priority-{{ mapping_info.priority }}"
                    >
                      {{ mapping_info.priority.upper() }}
                    </span>
                    {% else %}
                    <span style="color: #999">-</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if mapping_info.tag %} {{ mapping_info.level.title() }}
                    {% else %}
                    <span style="color: #999">-</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p>No column mappings found. Please go back and apply PXT tags.</p>
          {% endif %}
        </div>
      </div>

      <!-- Export Options -->
      {% if mappings %}
      <div class="note">
        <strong>Ready for Export:</strong> Your data has been successfully
        processed and is ready for download with embedded PXT tags. The exported
        CSV will include your original data with PXT tags added as column
        headers.
      </div>
      {% endif %}

      <!-- Action Buttons -->
      <div class="actions">
        <a href="{{ url_for('tag_data') }}" class="btn btn-secondary">
          ← Modify Tag Mappings
        </a>

        {% if mappings %}
        <a href="{{ url_for('export_csv') }}" class="btn btn-success">
          📥 Download Tagged CSV
        </a>
        {% endif %}

        <a href="{{ url_for('index') }}" class="btn btn-secondary">
          Start New Upload
        </a>
      </div>

      <!-- Footer -->
      <div class="footer">
        <p>PXT Web App - Workshop Demonstration Version</p>
        <p>Week 3: Complete workflow with CSV export functionality</p>
      </div>
    </div>

    <script>
      // Add visual feedback for completion status
      document.addEventListener('DOMContentLoaded', function() {
        const mappingPercentage = {{ validation.mapping_percentage|round|int }};
        const requiredCount = {{ validation.required_count }};
        const desirableCount = {{ validation.desirable_count }};
        const optionalCount = {{ validation.optional_count }};
        const untaggedColumns = {{ validation.untagged_columns }};

        console.log(`📊 Dataset Validation Summary:`);
        console.log(`   ${mappingPercentage}% of columns tagged`);
        console.log(`   ${requiredCount} required tags found`);
        console.log(`   ${desirableCount} desirable tags found`);
        console.log(`   ${optionalCount} optional tags found`);
        console.log(`   ${untaggedColumns} columns untagged`);

        if (mappingPercentage >= 80) {
          console.log('🎉 Excellent tag coverage! Ready for export.');
        } else if (mappingPercentage >= 50) {
          console.log('👍 Good tag coverage. Review suggestions before export.');
        } else {
          console.log('⚠️ Limited tag coverage. Consider reviewing untagged columns.');
        }
      });
    </script>
  </body>
</html>
